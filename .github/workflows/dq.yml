name: dq
on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euxo pipefail
          python -m pip install -U pip
          pip install -e '.[dev]'
          pip install "pandas>=2.2" "pyarrow>=16"

      - name: dq --help
        run: dq --help || true

  gate:
    runs-on: ubuntu-latest
    needs: smoke
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euxo pipefail
          python -m pip install -U pip
          pip install -e '.[dev]'
          pip install "pandas>=2.2" "pyarrow>=16"

      - name: Prepare sample.csv
        run: |
          python - <<'PY'
          import pathlib
          data = pathlib.Path('data'); data.mkdir(parents=True, exist_ok=True)
          p = data/'sample.csv'
          p.write_text('id,name\n1,alice\n2,bob\n'); print('wrote', p)
          PY

      - name: Run dq
        run: dq --input data/sample.csv --chunksize 50000
